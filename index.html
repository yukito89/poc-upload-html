<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <title>設計書アップロード</title>
    </head>
    <body>
        <h1>単体テスト仕様書</h1>

        <input type="file" id="fileInput" /><br />
        <input type="text" id="username" placeholder="ユーザー名" /><br />
        <input
            type="password"
            id="password"
            placeholder="パスワード"
        /><br /><br />
        <button id="uploadBtn">アップロードして生成</button>

        <p id="status"></p>

        <script>
            const fileInput = document.querySelector("#fileInput");
            const usernameInput = document.querySelector("#username");
            const passwordInput = document.querySelector("#password");
            const status = document.querySelector("#status");
            const uploadBtn = document.querySelector("#uploadBtn");

            uploadBtn.addEventListener("click", async () => {
                const file = fileInput.files[0];
                const username = usernameInput.value;
                const password = passwordInput.value;

                if (!file || !username || !password) {
                    status.textContent = "すべての項目を入力してください";
                    return;
                }

                uploadBtn.disabled = true;
                status.textContent = "認証中...";

                const formData = new FormData();
                formData.append("documentFile", file);
                const token = btoa(`${username}:${password}`);

                // ===== Azure Functions用 =====
                const endpoint = "https://poc-functions-sample-cbcrc6gzf5guhcc8.canadaeast-01.azurewebsites.net/api/upload";

                // ===== ローカル開発用 =====
                // const endpoint = 'http://localhost:7071/api/upload';

                try {
                    const res = await fetch(endpoint, {
                        method: "POST",
                        headers: { Authorization: `Basic ${token}` },
                        body: formData,
                    });

                    if (res.status === 401) {
                        status.textContent =
                            "認証失敗：ユーザー名またはパスワードが間違っています";
                        uploadBtn.disabled = false;
                        return;
                    }

                    if (!res.ok) {
                        status.textContent = `エラー: ${res.status}`;
                        uploadBtn.disabled = false;
                        return;
                    }

                    status.textContent = "認証成功。ファイル生成中...";

                    const blob = await res.blob();
                    status.textContent = "ダウンロード準備完了";

                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "TestSpecification.xlsx";
                    a.click();
                    URL.revokeObjectURL(url);

                    status.textContent = "完了しました";
                } catch (err) {
                    status.textContent = `通信エラー: ${err.message}`;
                } finally {
                    uploadBtn.disabled = false;
                }
            });
        </script>
    </body>
</html>
